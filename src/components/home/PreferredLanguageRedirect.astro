---
import type { Lang } from "../../config/i18n";

const {
  defaultLang,
  storageKey = "mq_lang",
  baseUrl,
}: {
  defaultLang: Lang;
  storageKey?: string;
  baseUrl?: string;
} = Astro.props;

const resolvedBase = baseUrl ?? import.meta.env.BASE_URL ?? "/";
const normalizedBase = resolvedBase.endsWith("/") ? resolvedBase : `${resolvedBase}/`;

const redirectScript = `
(function(){
  try {
    var storageKey = ${JSON.stringify(storageKey)};
    var defaultLang = ${JSON.stringify(defaultLang)};
    var base = ${JSON.stringify(normalizedBase)};
    var pref = localStorage.getItem(storageKey) || defaultLang;
    if (!pref) return;
    var path = window.location.pathname;
    var ref = document.referrer || '';
    var sameOrigin = false;
    try {
      sameOrigin = ref && new URL(ref).origin === window.location.origin;
    } catch(_) {
      sameOrigin = false;
    }
    if (!sameOrigin && pref && pref !== defaultLang) {
      var dest = base + pref + '/';
      if (path === base) {
        window.location.replace(dest);
      }
    }
  } catch (e) { /* no-op */ }
})();
`;
---
<script is:inline set:html={redirectScript}></script>
